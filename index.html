<!DOCTYPE html>
<html lang="pt-BR">
<head>
// ... existing code ...
</head>
<body>
    <div id="app"></div>

    <script>
// ... existing code ...

        //  Adicionando função para obter data no timezone do Brasil
        function getDateInBrazilTimezone(dateString) {
            if (!dateString) return new Date();
            const date = new Date(dateString);
            // Converter para timezone do Brasil (UTC-3)
            const brazilDate = new Date(date.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
            return brazilDate;
        }

        //  Atualizando formatDateBR para usar timezone correto
        function formatDateBR(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            // Usar explicitamente o timezone do Brasil
            return date.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
        }

        //  Atualizando filterSalesByPeriod para usar timezone correto
        function filterSalesByPeriod(sales, period) {
            const now = new Date();
            const nowBrazil = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
            
            return sales.filter(sale => {
                const saleDate = getDateInBrazilTimezone(sale.created_at);
                
                if (period === 'daily') {
                    return saleDate.toDateString() === nowBrazil.toDateString();
                } else if (period === 'weekly') {
                    const weekAgo = new Date(nowBrazil.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return saleDate >= weekAgo;
                } else if (period === 'monthly') {
                    const firstDay = new Date(nowBrazil.getFullYear(), nowBrazil.getMonth(), 1);
                    firstDay.setHours(0, 0, 0, 0);
                    const lastDay = new Date(nowBrazil.getFullYear(), nowBrazil.getMonth() + 1, 0);
                    lastDay.setHours(23, 59, 59, 999);
                    return saleDate >= firstDay && saleDate <= lastDay;
                } else if (period === 'custom') {
                    if (!customStartDate || !customEndDate) return true;
                    const startDate = new Date(customStartDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(customEndDate);
                    endDate.setHours(23, 59, 59, 999);
                    return saleDate >= startDate && saleDate <= endDate;
                }
                return true;
            });
        }

// ... existing code ...

        async function addSale(saleType, customerCPF, quantity, iccid, status, plan) {
            try {
                // Tentar criar o usuário na tabela users (ignorar se já existir)
                try {
                    await supabase.from('users').upsert([{
                        id: currentUser.id,
                        full_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        phone: currentUser.user_metadata?.phone || '',
                        password: ''
                    }], { onConflict: 'id' });
                } catch (upsertError) {
                    console.log('Usuário já existe ou erro ao criar:', upsertError);
                }
                
                const finalStatus = saleType === 'BrisaChip' ? 'Efetivado' : (status || 'Pendente');
                
                //  Usando timezone do Brasil para created_at
                const nowBrazil = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
                
                const saleData = {
                    user_id: currentUser.id,
                    service_type: saleType,
                    customer_cpf: customerCPF,
                    quantity: parseInt(quantity),
                    iccid: iccid || null,
                    status: finalStatus,
                    created_at: nowBrazil.toISOString()
                };
                
                if (plan) {
                    saleData.plan = plan;
                }
                
                const result = await supabase.from('sales').insert([saleData]);
                
                if (result.error) throw result.error;
                return true;
            } catch (error) {
                console.error('Erro completo:', error);
                alert('Erro ao registrar venda: ' + error.message);
                return false;
            }
        }

// ... existing code ...
    </script>
</body>
</html>
