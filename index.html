<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Vendas Brisanet</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { 
            background: #2a2a2a; 
            border-radius: 12px; 
            padding: 30px; 
            margin-bottom: 20px;
            border: 2px solid #ff6b00;
            box-shadow: 0 8px 32px rgba(255, 107, 0, 0.2);
        }
        h1, h2 { color: #ff6b00; margin-bottom: 20px; font-weight: 600; }
        h1 { font-size: 28px; }
        h2 { font-size: 22px; }
        input, select, button { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: none;
            font-size: 14px;
        }
        input, select { 
            background: #3a3a3a; 
            color: #fff;
            border: 1px solid #555;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #ff6b00;
        }
        button { 
            background: #ff6b00; 
            color: #fff; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { background: #ff8c00; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #dc3545; }
        .btn-secondary:hover { background: #c82333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .stat-card { 
            background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%); 
            padding: 25px; 
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(255, 107, 0, 0.3);
        }
        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0.95;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-value { font-size: 36px; font-weight: 700; margin: 10px 0; }
        .period-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .period-btn {
            background: #3a3a3a;
            color: #fff;
            border: 2px solid #555;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            width: auto;
        }
        .period-btn:hover {
            border-color: #ff6b00;
            background: #404040;
        }
        .period-btn.active {
            background: #ff6b00;
            border-color: #ff6b00;
            transform: none;
        }
        .date-range-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            padding: 30px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 12px;
            border: 2px solid #ff6b00;
            box-shadow: 0 4px 20px rgba(255, 107, 0, 0.3);
        }
        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        .date-input-label {
            color: #ff6b00;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }
        .date-button {
            background: #3a3a3a;
            border: 2px solid #555;
            color: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }
        .date-button:hover {
            border-color: #ff6b00;
            background: #404040;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.2);
            transform: translateY(-2px);
        }
        .date-button .date-icon {
            color: #ff6b00;
            pointer-events: none;
            position: relative;
            z-index: 1;
        }
        .date-button input[type="date"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            left: 0;
            top: 0;
            z-index: 100;
        }
        .date-button span {
            pointer-events: none;
            position: relative;
            z-index: 1;
        }

        .btn-apply {
            background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%);
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
            width: auto;
        }
        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 0, 0.5);
        }
        .btn-delete {
            background: #dc3545;
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .service-stat-card {
            background: linear-gradient(135deg, #3a3a3a 0%, #454545 100%);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #ff6b00;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .service-stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .service-icon-wrapper {
            background: rgba(255, 107, 0, 0.15);
            padding: 10px;
            border-radius: 8px;
        }
        .service-stat-value {
            font-size: 40px;
            font-weight: 700;
            color: #ff6b00;
            margin: 10px 0;
        }
        .service-stat-label {
            color: #999;
            font-size: 13px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #444; }
        th { color: #ff6b00; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { font-size: 14px; }
        .text-center { text-align: center; }
        .link { color: #ff6b00; cursor: pointer; text-decoration: none; font-weight: 500; }
        .link:hover { text-decoration: underline; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .section-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-efetivado {
            background: #28a745;
            color: white;
        }
        .status-pendente {
            background: #ffc107;
            color: #1a1a1a;
        }
        .icon { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 32px; height: 32px; }
        .form-group { margin-bottom: 15px; }
        .form-label { 
            display: block; 
            color: #999; 
            font-size: 13px; 
            margin-bottom: 5px;
            font-weight: 500;
        }
        .sale-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .sale-type-card {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        .sale-type-card:hover {
            border-color: #ff6b00;
            background: #404040;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }
        .sale-type-card.active {
            border-color: #ff6b00;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.2) 0%, rgba(255, 107, 0, 0.1) 100%);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
            transform: scale(1.05);
        }
        .sale-type-card.active::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b00;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        .sale-type-card h3 {
            color: #fff;
            margin: 10px 0 5px 0;
            font-size: 16px;
        }
        .sale-type-card.active h3 {
            color: #ff6b00;
            font-weight: 600;
        }
        .sale-type-card p {
            color: #999;
            font-size: 12px;
        }
        .sale-type-card.active p {
            color: #ffb366;
        }
        .plan-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .plan-card {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #555;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        .plan-card:hover {
            border-color: #ff6b00;
            background: #404040;
            transform: translateY(-2px);
        }
        .plan-card.active {
            border-color: #ff6b00;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.2) 0%, rgba(255, 107, 0, 0.1) 100%);
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.4);
        }
        .plan-card.active::before {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff6b00;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .plan-gb {
            font-size: 24px;
            font-weight: 700;
            color: #ff6b00;
            margin-bottom: 5px;
        }
        .plan-price {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
        }
        .footer-credits {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 13px;
            margin-top: 30px;
        }
        .footer-credits strong {
            color: #ff6b00;
        }
        .system-title {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(255, 107, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .system-title h1 {
            font-size: 32px;
            font-weight: 800;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            line-height: 1.3;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .system-title .title-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .system-title .subtitle {
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
            opacity: 0.95;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; margin-bottom: 15px; }
            .grid { grid-template-columns: 1fr; gap: 10px; }
            .stat-value { font-size: 28px; }
            .service-stat-value { font-size: 32px; }
            h1 { font-size: 20px; }
            h2 { font-size: 18px; }
            .system-title h1 { font-size: 24px; gap: 10px; }
            .system-title .subtitle { font-size: 12px; }
            .system-title { padding: 20px; margin-bottom: 20px; }
            .flex-between { flex-direction: column; align-items: flex-start; }
            .section-header { flex-wrap: wrap; gap: 8px; }
            .period-selector { gap: 8px; }
            .period-btn { padding: 8px 16px; font-size: 13px; }
            .sale-type-selector { grid-template-columns: 1fr; gap: 10px; }
            .sale-type-card { padding: 15px; }
            .plan-selector { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
            .plan-gb { font-size: 20px; }
            .plan-price { font-size: 14px; }
            .date-range-selector { padding: 20px; gap: 10px; flex-direction: column; }
            .date-input-group { min-width: 100%; width: 100%; }
            .date-button { min-width: 100%; width: 100%; padding: 12px 15px; font-size: 14px; }
            .btn-apply { width: 100%; padding: 12px; margin-top: 10px !important; }
            table { font-size: 12px; }
            th, td { padding: 10px 8px; }
            th { font-size: 11px; }
            .status-badge { font-size: 10px; padding: 4px 8px; }
            button { font-size: 13px; padding: 10px; }
            .btn-delete { padding: 6px 12px; font-size: 11px; }
            .service-stat-header { flex-direction: column; text-align: center; gap: 8px; }
            .service-stat-header span { font-size: 13px; }
            .form-group { margin-bottom: 10px; }
            input, select { font-size: 16px; padding: 12px; }
            .stat-card { padding: 20px; }
            .stat-card-header { font-size: 13px; }
            .service-stat-card { padding: 20px; }
            .icon-xl { width: 24px; height: 24px; }
            .icon-lg { width: 20px; height: 20px; }
            .empty-state { padding: 40px 15px; font-size: 14px; }
            .footer-credits { font-size: 12px; padding: 15px; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 18px; }
            h2 { font-size: 16px; }
            .system-title h1 { font-size: 20px; }
            .stat-value { font-size: 24px; }
            .service-stat-value { font-size: 28px; }
            .period-btn { padding: 8px 12px; font-size: 12px; }
            table { display: block; overflow-x: auto; white-space: nowrap; }
            .date-input-label { font-size: 11px; }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
            .grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://uijtwnzfhkgzxmdtrxjm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpanR3bnpmaGtnenhtZHRyeGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMTY5NzksImV4cCI6MjA3NTc5Mjk3OX0.pM9RF3LKPzWpBqiXi75Mj9wQiRw4ysbaItfFPEdq6fE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPage = 'login';
        let currentUser = null;
        let selectedSaleType = '';
        let selectedPeriod = 'monthly';
        let customStartDate = '';
        let customEndDate = '';
        let selectedPlan = '';

        const icons = {
            user: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            userLg: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            lockLg: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',
            dashboard: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',
            chart: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>',
            package: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
            shoppingCart: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>',
            list: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>',
            logout: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
            check: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            wifi: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>',
            smartphone: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
            layers: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
            inbox: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>',
            calendar: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            clock: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
            barChart: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>'
        };

        function updateDateTime() {
            const now = new Date();
            const options = { timeZone: 'America/Sao_Paulo' };
            
            const hours = now.toLocaleString('pt-BR', { ...options, hour: '2-digit', hour12: false });
            const minutes = now.toLocaleString('pt-BR', { ...options, minute: '2-digit' });
            const seconds = now.toLocaleString('pt-BR', { ...options, second: '2-digit' });
            const date = now.toLocaleDateString('pt-BR', options);
            const dayName = now.toLocaleDateString('pt-BR', { ...options, weekday: 'long' });
            
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            const dayElement = document.getElementById('currentDay');
            
            if (timeElement) {
                timeElement.innerHTML = `${hours}<span class="time-separator">:</span>${minutes}<span class="time-separator">:</span>${seconds}`;
            }
            if (dateElement) {
                dateElement.textContent = date;
            }
            if (dayElement) {
                dayElement.textContent = dayName.charAt(0).toUpperCase() + dayName.slice(1);
            }
        }

        setInterval(updateDateTime, 1000);

        async function register(fullName, email, phone, password) {
            try {
                const result = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName,
                            phone: phone
                        }
                    }
                });
                
                if (result.error) throw result.error;
                
                if (result.data.user) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Tentar inserir o usuário na tabela users
                    const insertResult = await supabase.from('users').insert([{
                        id: result.data.user.id,
                        full_name: fullName,
                        email: email,
                        phone: phone,
                        password: password
                    }]);
                    
                    if (insertResult.error) {
                        console.error('Erro ao inserir na tabela users:', insertResult.error);
                        // Se falhar, deletar o usuário do auth para evitar inconsistência
                        await supabase.auth.admin.deleteUser(result.data.user.id);
                        throw new Error('Erro ao criar usuário. Tente novamente.');
                    }

                    try {
                        const webhookData = {
                            full_name: fullName,
                            email: email,
                            phone: phone,
                            user_id: result.data.user.id,
                            created_at: new Date().toISOString(),
                            event: 'user_registered'
                        };
                        
                        console.log('Enviando webhook:', webhookData);
                        
                        const webhookResponse = await fetch('https://n8n-n8n.rthuab.easypanel.host/webhook/fluxo', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(webhookData)
                        });
                        
                        if (webhookResponse.ok) {
                            console.log('Webhook enviado com sucesso!');
                        } else {
                            console.warn('Webhook retornou status:', webhookResponse.status);
                        }
                    } catch (webhookError) {
                        console.error('Erro ao enviar webhook:', webhookError);
                    }
                }
                
                alert('Cadastro realizado com sucesso! Faça login para continuar.');
                return true;
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao cadastrar: ' + error.message);
                return false;
            }
        }

        async function login(email, password) {
            try {
                const result = await supabase.auth.signInWithPassword({ email, password });
                if (result.error) throw result.error;
                
                // Verificar se o usuário existe na tabela users
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', result.data.user.id)
                    .single();
                
                // Se não existir, criar o registro
                if (userError || !userData) {
                    console.log('Usuário não encontrado na tabela users, criando...');
                    const { error: insertError } = await supabase.from('users').insert([{
                        id: result.data.user.id,
                        full_name: result.data.user.user_metadata?.full_name || '',
                        email: result.data.user.email,
                        phone: result.data.user.user_metadata?.phone || '',
                        password: ''
                    }]);
                    
                    if (insertError) {
                        console.error('Erro ao criar usuário na tabela:', insertError);
                    }
                }
                
                currentUser = result.data.user;
                return true;
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao fazer login: ' + error.message);
                return false;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
        }

        async function addSale(saleType, customerCPF, quantity, iccid, status, plan) {
            try {
                const finalStatus = saleType === 'BrisaChip' ? 'Efetivado' : (status || 'Pendente');
                
                const saleData = {
                    user_id: currentUser.id,
                    service_type: saleType,
                    customer_cpf: customerCPF,
                    quantity: parseInt(quantity),
                    iccid: iccid || null,
                    status: finalStatus,
                    created_at: new Date().toISOString()
                };
                
                if (plan) {
                    saleData.plan = plan;
                }
                
                const result = await supabase.from('sales').insert([saleData]);
                
                if (result.error) throw result.error;
                return true;
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro: ' + error.message);
                return false;
            }
        }

        async function deleteSale(saleId) {
            try {
                const result = await supabase.from('sales').delete().eq('id', saleId).eq('user_id', currentUser.id);
                if (result.error) throw result.error;
                return true;
            } catch (error) {
                console.error('Erro:', error);
                return false;
            }
        }

        async function getSales() {
            try {
                const result = await supabase.from('sales').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
                return result.error ? [] : result.data;
            } catch (error) {
                return [];
            }
        }

        function filterSalesByPeriod(sales, period) {
            const now = new Date();
            return sales.filter(sale => {
                const saleDate = new Date(sale.created_at);
                
                if (period === 'daily') {
                    return saleDate.toDateString() === now.toDateString();
                } else if (period === 'weekly') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return saleDate >= weekAgo;
                } else if (period === 'monthly') {
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    firstDay.setHours(0, 0, 0, 0);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    lastDay.setHours(23, 59, 59, 999);
                    return saleDate >= firstDay && saleDate <= lastDay;
                } else if (period === 'custom') {
                    if (!customStartDate || !customEndDate) return true;
                    const startDate = new Date(customStartDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(customEndDate);
                    endDate.setHours(23, 59, 59, 999);
                    return saleDate >= startDate && saleDate <= endDate;
                }
                return true;
            });
        }

        function formatDateBR(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        async function updateSaleStatus(saleId, newStatus) {
            try {
                const result = await supabase.from('sales').update({ status: newStatus }).eq('id', saleId).eq('user_id', currentUser.id);
                if (result.error) throw result.error;
                return true;
            } catch (error) {
                console.error('Erro:', error);
                return false;
            }
        }

        function renderRegisterPage() {
            return `
                <div class="container">
                    <div style="max-width: 500px; margin: 80px auto;">
                        <div class="system-title">
                            <h1>
                                <span class="title-icon">${icons.barChart}</span>
                                <span>Registro de Vendas<br>Brisanet</span>
                            </h1>
                            <div class="subtitle">Sistema de Gestão Comercial</div>
                        </div>
                        <div class="card">
                            <div class="section-header" style="justify-content: center;">
                                ${icons.userLg}
                                <h1>Cadastro de Usuário</h1>
                            </div>
                            <input type="text" id="fullName" placeholder="Nome Completo" required>
                            <input type="email" id="email" placeholder="Email" required>
                            <div class="form-group" style="margin: 10px 0;">
                                <label class="form-label" style="margin-bottom: 5px;">📱 Telefone (WhatsApp) - Código do país obrigatório</label>
                                <input type="tel" id="phone" placeholder="Ex: 55 85 98765-4321" value="55 " required style="margin: 0;">
                            </div>
                            <input type="password" id="password" placeholder="Senha (mínimo 6 caracteres)" required>
                            <button id="btnRegister" onclick="handleRegister()">
                                ${icons.check}
                                <span>Cadastrar</span>
                            </button>
                            <p class="text-center" style="margin-top: 15px; color: #999;">
                                Já tem uma conta? 
                                <span class="link" onclick="changePage('login')">Faça login</span>
                            </p>
                        </div>
                        <div class="footer-credits">
                            Desenvolvido por <strong>Igor Borges</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginPage() {
            return `
                <div class="container">
                    <div style="max-width: 500px; margin: 80px auto;">
                        <div class="system-title">
                            <h1>
                                <span class="title-icon">${icons.barChart}</span>
                                <span>Registro de Vendas<br>Brisanet</span>
                            </h1>
                            <div class="subtitle">Sistema de Gestão Comercial</div>
                        </div>
                        <div class="card">
                            <div class="section-header" style="justify-content: center;">
                                ${icons.lockLg}
                                <h1>Login</h1>
                            </div>
                            <input type="email" id="loginEmail" placeholder="Email">
                            <input type="password" id="loginPassword" placeholder="Senha">
                            <button id="btnLogin" onclick="handleLogin()">
                                ${icons.check}
                                <span>Entrar</span>
                            </button>
                            <button onclick="changePage('register')" style="background: #3a3a3a; margin-top: 10px;">
                                ${icons.userLg}
                                <span>Criar Conta</span>
                            </button>
                        </div>
                        <div class="footer-credits">
                            Desenvolvido por <strong>Igor Borges</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderDashboard() {
            const allSales = await getSales();
            const sales = filterSalesByPeriod(allSales, selectedPeriod);
            
            const totalSales = sales.length;
            const efetivados = sales.filter(s => s.status === 'Efetivado').length;
            const pendentes = sales.filter(s => s.status === 'Pendente').length;
            
            const comboSales = sales.filter(s => s.service_type === 'Combo').length;
            const chipSales = sales.filter(s => s.service_type === 'BrisaChip').length;
            const fibraSales = sales.filter(s => s.service_type === 'Fibra').length;
            
            const now = new Date();
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const currentMonth = monthNames[now.getMonth()];
            const currentYear = now.getFullYear();
            
            let periodText = '';
            if (selectedPeriod === 'daily') periodText = 'Hoje';
            else if (selectedPeriod === 'weekly') periodText = 'Esta Semana';
            else if (selectedPeriod === 'monthly') periodText = `${currentMonth} de ${currentYear}`;
            else if (selectedPeriod === 'custom') {
                periodText = (customStartDate && customEndDate) 
                    ? formatDateBR(customStartDate) + ' até ' + formatDateBR(customEndDate)
                    : 'Período Personalizado';
            }

            return `
                <div class="container">
                    <div class="system-title" style="margin-top: 20px;">
                        <h1>
                            <span class="title-icon">${icons.barChart}</span>
                            <span>Registro de Vendas Brisanet</span>
                        </h1>
                        <div class="subtitle">Sistema de Gestão Comercial</div>
                    </div>
                    
                    <div class="card">
                        <div class="flex-between">
                            <div class="section-header" style="margin: 0;">
                                ${icons.dashboard}
                                <div>
                                    <h1 style="margin: 0;">Dashboard de Vendas</h1>
                                    <p style="color: #999; margin-top: 5px;">Bem-vindo, ${currentUser.user_metadata?.full_name || currentUser.email}</p>
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="handleLogout()" style="width: auto; padding: 12px 24px;">
                                ${icons.logout}
                                <span>Sair</span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 style="text-align: center; margin-bottom: 15px;">Período: ${periodText}</h2>
                        <div class="period-selector">
                            <button class="period-btn ${selectedPeriod === 'daily' ? 'active' : ''}" onclick="changePeriod('daily')">Diário</button>
                            <button class="period-btn ${selectedPeriod === 'weekly' ? 'active' : ''}" onclick="changePeriod('weekly')">Semanal</button>
                            <button class="period-btn ${selectedPeriod === 'monthly' ? 'active' : ''}" onclick="changePeriod('monthly')">Mensal</button>
                            <button class="period-btn ${selectedPeriod === 'custom' ? 'active' : ''}" onclick="changePeriod('custom')">Personalizado</button>
                        </div>
                        ${selectedPeriod === 'custom' ? `
                            <div class="date-range-selector">
                                <div class="date-input-group">
                                    <div class="date-input-label">${icons.calendar} Data Inicial</div>
                                    <button class="date-button" id="startDateBtn">
                                        <div class="date-icon">${icons.calendar}</div>
                                        <span id="startDateText">${customStartDate ? formatDateBR(customStartDate) : 'Selecionar Data'}</span>
                                        <input type="date" id="startDate" value="${customStartDate}" onchange="updateCustomDate('start')">
                                    </button>
                                </div>
                                
                                <div class="date-input-group">
                                    <div class="date-input-label">${icons.calendar} Data Final</div>
                                    <button class="date-button" id="endDateBtn">
                                        <div class="date-icon">${icons.calendar}</div>
                                        <span id="endDateText">${customEndDate ? formatDateBR(customEndDate) : 'Selecionar Data'}</span>
                                        <input type="date" id="endDate" value="${customEndDate}" onchange="updateCustomDate('end')">
                                    </button>
                                </div>
                                
                                <button onclick="applyCustomPeriod()" class="btn-apply" style="margin-top: 24px;">
                                    ${icons.check}
                                    <span>Aplicar Período</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.chart}
                                <span>Total de Vendas</span>
                            </div>
                            <div class="stat-value">${totalSales}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.check}
                                <span>Efetivados</span>
                            </div>
                            <div class="stat-value">${efetivados}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.package}
                                <span>Pendentes</span>
                            </div>
                            <div class="stat-value">${pendentes}</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.layers}
                            <h2 style="margin: 0;">Vendas por Tipo de Serviço (${periodText})</h2>
                        </div>
                        <div class="grid">
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">${icons.layers}</div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">Combo (Internet + Chip)</span>
                                </div>
                                <div class="service-stat-value">${comboSales}</div>
                                <div class="service-stat-label">vendas realizadas</div>
                            </div>
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">${icons.smartphone}</div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">BrisaChip</span>
                                </div>
                                <div class="service-stat-value">${chipSales}</div>
                                <div class="service-stat-label">chips vendidos</div>
                            </div>
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">${icons.wifi}</div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">FTTH (Fibra Óptica)</span>
                                </div>
                                <div class="service-stat-value">${fibraSales}</div>
                                <div class="service-stat-label">fibras instaladas</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.shoppingCart}
                            <h2 style="margin: 0;">Registrar Nova Venda</h2>
                        </div>
                        
                        <div class="sale-type-selector">
                            <div class="sale-type-card ${selectedSaleType === 'Combo' ? 'active' : ''}" onclick="selectSaleType('Combo')">
                                ${icons.layers}
                                <h3>Internet Fibra + BrisaChip</h3>
                                <p>Combo completo</p>
                            </div>
                            <div class="sale-type-card ${selectedSaleType === 'BrisaChip' ? 'active' : ''}" onclick="selectSaleType('BrisaChip')">
                                ${icons.smartphone}
                                <h3>BrisaChip</h3>
                                <p>Chip avulso</p>
                            </div>
                            <div class="sale-type-card ${selectedSaleType === 'Fibra' ? 'active' : ''}" onclick="selectSaleType('Fibra')">
                                ${icons.wifi}
                                <h3>Fibra Óptica</h3>
                                <p>Internet avulsa</p>
                            </div>
                        </div>

                        <div id="saleForm"></div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.list}
                            <h2 style="margin: 0;">Histórico de Vendas (${periodText})</h2>
                        </div>
                        ${sales.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>CPF</th>
                                            <th>Qtd</th>
                                            <th>ICCID</th>
                                            <th>Plano</th>
                                            <th>Status</th>
                                            <th>Data</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sales.map(sale => `
                                            <tr>
                                                <td>${sale.service_type}</td>
                                                <td>${sale.customer_cpf}</td>
                                                <td>${sale.quantity}</td>
                                                <td>${sale.iccid || '-'}</td>
                                                <td>${sale.plan || '-'}</td>
                                                <td>
                                                    <span class="status-badge status-${sale.status.toLowerCase()}">
                                                        ${sale.status}
                                                    </span>
                                                </td>
                                                <td>${formatDateBR(sale.created_at)}</td>
                                                <td style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                    ${sale.service_type !== 'BrisaChip' ? (
                                                        sale.status === 'Pendente' 
                                                        ? `<button onclick="toggleStatus('${sale.id}', 'Efetivado')" style="width: auto; padding: 8px 16px; font-size: 12px; background: #28a745; white-space: nowrap;">Efetivar</button>`
                                                        : `<button onclick="toggleStatus('${sale.id}', 'Pendente')" style="width: auto; padding: 8px 16px; font-size: 12px; background: #ffc107; color: #1a1a1a; white-space: nowrap;">Pendente</button>`
                                                    ) : ''}
                                                    <button onclick="handleDeleteSale('${sale.id}')" class="btn-delete" style="white-space: nowrap;">Excluir</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                ${icons.inbox}
                                <p>Nenhuma venda registrada neste período</p>
                            </div>
                        `}
                    </div>
                    <div class="footer-credits">
                        Desenvolvido por <strong>Igor Borges</strong>
                    </div>
                </div>
            `;
        }

        function selectSaleType(type) {
            selectedSaleType = type;
            selectedPlan = '';
            
            const cards = document.querySelectorAll('.sale-type-card');
            cards.forEach(card => card.classList.remove('active'));
            
            event.target.closest('.sale-type-card').classList.add('active');
            
            renderSaleForm();
        }

        function selectPlan(plan) {
            selectedPlan = plan;
            
            const planCards = document.querySelectorAll('.plan-card');
            planCards.forEach(card => card.classList.remove('active'));
            
            if (event && event.target) {
                const clickedCard = event.target.closest('.plan-card');
                if (clickedCard) {
                    clickedCard.classList.add('active');
                }
            }
        }

        function renderSaleForm() {
            const formContainer = document.getElementById('saleForm');
            if (!formContainer) return;

            let formHTML = '';

            if (selectedSaleType === 'Combo') {
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">CPF do Cliente</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="status">
                            <option value="Pendente">Pendente</option>
                            <option value="Efetivado">Efetivado</option>
                        </select>
                    </div>
                    <button onclick="handleAddSale()">
                        ${icons.check}
                        <span>Registrar Venda</span>
                    </button>
                `;
            } else if (selectedSaleType === 'BrisaChip') {
                formHTML = `
                    <div class="form-label" style="margin-bottom: 10px;">Selecione o Plano:</div>
                    <div class="plan-selector">
                        <div class="plan-card ${selectedPlan === '20GB - R$ 29,99' ? 'active' : ''}" onclick="selectPlan('20GB - R$ 29,99')">
                            <div class="plan-gb">20GB</div>
                            <div class="plan-price">R$ 29,99</div>
                        </div>
                        <div class="plan-card ${selectedPlan === '30GB - R$ 39,99' ? 'active' : ''}" onclick="selectPlan('30GB - R$ 39,99')">
                            <div class="plan-gb">30GB</div>
                            <div class="plan-price">R$ 39,99</div>
                        </div>
                        <div class="plan-card ${selectedPlan === '100GB - R$ 49,99' ? 'active' : ''}" onclick="selectPlan('100GB - R$ 49,99')">
                            <div class="plan-gb">100GB</div>
                            <div class="plan-price">R$ 49,99</div>
                        </div>
                    </div>
                    ${selectedPlan ? `
                        <div style="background: rgba(255, 107, 0, 0.1); border: 2px solid #ff6b00; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center;">
                            <span style="color: #ff6b00; font-weight: 600; font-size: 14px;">✓ Plano Selecionado: ${selectedPlan}</span>
                        </div>
                    ` : ''}
                    <div class="form-group">
                        <label class="form-label">CPF do Cliente</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ICCID (Últimos 8 dígitos - Obrigatório)</label>
                        <input type="text" id="iccid" placeholder="Digite os 8 últimos dígitos" maxlength="8">
                    </div>
                    <button onclick="handleAddSale()">
                        ${icons.check}
                        <span>Registrar Venda</span>
                    </button>
                `;
            } else if (selectedSaleType === 'Fibra') {
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">CPF do Cliente</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="status">
                            <option value="Pendente">Pendente</option>
                            <option value="Efetivado">Efetivado</option>
                        </select>
                    </div>
                    <button onclick="handleAddSale()">
                        ${icons.check}
                        <span>Registrar Venda</span>
                    </button>
                `;
            } else {
                formHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">Selecione um tipo de serviço acima</p>';
            }

            formContainer.innerHTML = formHTML;
        }

        async function handleRegister() {
            const btn = document.getElementById('btnRegister');
            btn.disabled = true;
            btn.innerHTML = icons.check + '<span>Cadastrando...</span>';
            
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            let phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;

            if (!fullName) {
                alert('O campo Nome Completo é obrigatório!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            if (!email) {
                alert('O campo Email é obrigatório!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor, insira um email válido!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            if (!phone.startsWith('55')) {
                phone = '55 ' + phone;
            }

            if (!phone || phone === '55' || phone === '55 ' || phone.replace(/\D/g, '').length < 12) {
                alert('Por favor, insira um número de telefone válido com DDD!\nFormato: 55 85 98765-4321');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            if (!password) {
                alert('O campo Senha é obrigatório!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            if (password.length < 6) {
                alert('A senha deve ter no mínimo 6 caracteres!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            const success = await register(fullName, email, phone, password);
            if (success) {
                changePage('login');
            }
            
            btn.disabled = false;
            btn.innerHTML = icons.check + '<span>Cadastrar</span>';
        }

        async function handleLogin() {
            const btn = document.getElementById('btnLogin');
            btn.disabled = true;
            btn.innerHTML = icons.check + '<span>Entrando...</span>';
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Preencha todos os campos!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Entrar</span>';
                return;
            }

            const success = await login(email, password);
            if (success) {
                await changePage('dashboard');
            }
            
            btn.disabled = false;
            btn.innerHTML = icons.check + '<span>Entrar</span>';
        }

        async function handleLogout() {
            if (confirm('Deseja realmente sair?')) {
                await logout();
                changePage('login');
            }
        }

        async function handleAddSale() {
            const cpfInput = document.getElementById('customerCPF');
            const quantityInput = document.getElementById('quantity');
            const iccidInput = document.getElementById('iccid');
            const statusInput = document.getElementById('status');
            
            const customerCPF = cpfInput ? cpfInput.value.trim() : '';
            const quantity = quantityInput ? quantityInput.value : '1';
            const iccid = iccidInput ? iccidInput.value.trim() : '';
            const status = statusInput ? statusInput.value : 'Pendente';

            if (!selectedSaleType) {
                alert('Selecione o tipo de serviço!');
                return;
            }

            if (!customerCPF || !quantity) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            if (selectedSaleType === 'BrisaChip') {
                if (!iccid) {
                    alert('O campo ICCID é obrigatório para BrisaChip!');
                    return;
                }
                if (iccid.length !== 8) {
                    alert('O ICCID deve ter exatamente 8 dígitos!');
                    return;
                }
                if (!/^\d{8}$/.test(iccid)) {
                    alert('O ICCID deve conter apenas números!');
                    return;
                }
                if (!selectedPlan) {
                    alert('Selecione um plano para BrisaChip!');
                    return;
                }
            }

            const success = await addSale(selectedSaleType, customerCPF, quantity, iccid, status, selectedPlan);
            if (success) {
                alert('Venda registrada com sucesso!');
                selectedSaleType = '';
                selectedPlan = '';
                await changePage('dashboard');
            }
        }

        async function toggleStatus(saleId, newStatus) {
            const success = await updateSaleStatus(saleId, newStatus);
            if (success) {
                await changePage('dashboard');
            }
        }

        async function handleDeleteSale(saleId) {
            if (confirm('Tem certeza que deseja excluir esta venda?')) {
                const success = await deleteSale(saleId);
                if (success) {
                    await changePage('dashboard');
                }
            }
        }

        function changePeriod(period) {
            selectedPeriod = period;
            if (period !== 'custom') {
                customStartDate = '';
                customEndDate = '';
            } else if (period === 'custom' && !customStartDate && !customEndDate) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                customStartDate = `${year}-${month}-${day}`;
                customEndDate = `${year}-${month}-${day}`;
            }
            changePage('dashboard');
        }

        function updateCustomDate(type) {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            const startText = document.getElementById('startDateText');
            const endText = document.getElementById('endDateText');
            
            if (type === 'start' && startInput) {
                customStartDate = startInput.value;
                if (startText && customStartDate) {
                    startText.textContent = formatDateBR(customStartDate);
                }
            } else if (type === 'end' && endInput) {
                customEndDate = endInput.value;
                if (endText && customEndDate) {
                    endText.textContent = formatDateBR(customEndDate);
                }
            }
        }

        function applyCustomPeriod() {
            if (!customStartDate || !customEndDate) {
                alert('Selecione as datas de início e fim!');
                return;
            }
            if (new Date(customStartDate) > new Date(customEndDate)) {
                alert('A data inicial não pode ser maior que a data final!');
                return;
            }
            changePage('dashboard');
        }

        async function changePage(page) {
            currentPage = page;
            await render();
        }

        async function render() {
            let html = '';
            
            if (currentPage === 'register') {
                html = renderRegisterPage();
            } else if (currentPage === 'login') {
                html = renderLoginPage();
            } else if (currentPage === 'dashboard') {
                html = await renderDashboard();
            }
            
            document.getElementById('app').innerHTML = html;
        }

        async function init() {
            const sessionResult = await supabase.auth.getSession();
            
            if (sessionResult.data.session) {
                currentUser = sessionResult.data.session.user;
                currentPage = 'dashboard';
            }
            
            await render();
        }

        init();
    </script>
</body>
</html>
