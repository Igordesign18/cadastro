<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { 
            background: #2a2a2a; 
            border-radius: 12px; 
            padding: 30px; 
            margin-bottom: 20px;
            border: 2px solid #ff6b00;
            box-shadow: 0 8px 32px rgba(255, 107, 0, 0.2);
        }
        h1, h2 { color: #ff6b00; margin-bottom: 20px; font-weight: 600; }
        h1 { font-size: 28px; }
        h2 { font-size: 22px; }
        input, select, button { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: none;
            font-size: 14px;
        }
        input, select { 
            background: #3a3a3a; 
            color: #fff;
            border: 1px solid #555;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #ff6b00;
        }
        button { 
            background: #ff6b00; 
            color: #fff; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { background: #ff8c00; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #dc3545; }
        .btn-secondary:hover { background: #c82333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-card { 
            background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%); 
            padding: 25px; 
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(255, 107, 0, 0.3);
        }
        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0.95;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-value { font-size: 36px; font-weight: 700; margin: 10px 0; }
        .period-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .period-btn {
            background: #3a3a3a;
            color: #fff;
            border: 2px solid #555;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            width: auto;
        }
        .period-btn:hover {
            border-color: #ff6b00;
            background: #404040;
        }
        .period-btn.active {
            background: #ff6b00;
            border-color: #ff6b00;
            transform: none;
        }
        .date-range-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            padding: 20px;
            background: #333;
            border-radius: 12px;
            border: 2px solid #555;
        }
        .date-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .date-input {
            background: #2a2a2a;
            color: #fff;
            border: 2px solid #555;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            width: 180px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .date-input:hover {
            border-color: #ff6b00;
            background: #333;
        }
        .date-input:focus {
            border-color: #ff6b00;
            outline: none;
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.3);
        }
        .date-label {
            color: #ff6b00;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-apply {
            background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%);
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
            margin-top: 18px;
        }
        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 0, 0.5);
        }
        .btn-apply:active {
            transform: translateY(0);
        }
        .btn-delete {
            background: #dc3545;
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .btn-approve {
            background: #28a745;
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }
        .btn-approve:hover {
            background: #218838;
        }
        .btn-reject {
            background: #dc3545;
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }
        .btn-reject:hover {
            background: #c82333;
        }
        .payment-card {
            max-width: 500px;
            margin: 100px auto;
            text-align: center;
        }
        .payment-value {
            font-size: 48px;
            font-weight: 700;
            color: #ff6b00;
            margin: 20px 0;
        }
        .payment-info {
            background: rgba(255, 107, 0, 0.1);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ff6b00;
            margin: 20px 0;
        }
        .service-stat-card {
            background: linear-gradient(135deg, #3a3a3a 0%, #454545 100%);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #ff6b00;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .service-stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .service-icon-wrapper {
            background: rgba(255, 107, 0, 0.15);
            padding: 10px;
            border-radius: 8px;
        }
        .service-stat-value {
            font-size: 40px;
            font-weight: 700;
            color: #ff6b00;
            margin: 10px 0;
        }
        .service-stat-label {
            color: #999;
            font-size: 13px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #444; }
        th { color: #ff6b00; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { font-size: 14px; }
        .text-center { text-align: center; }
        .link { color: #ff6b00; cursor: pointer; text-decoration: none; font-weight: 500; }
        .link:hover { text-decoration: underline; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .section-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state svg {
            opacity: 0.3;
            margin-bottom: 20px;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-efetivado {
            background: #28a745;
            color: white;
        }
        .status-pendente {
            background: #ffc107;
            color: #1a1a1a;
        }
        .icon { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 32px; height: 32px; }
        .form-group { margin-bottom: 15px; }
        .form-label { 
            display: block; 
            color: #999; 
            font-size: 13px; 
            margin-bottom: 5px;
            font-weight: 500;
        }
        .sale-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .sale-type-card {
            background: #3a3a3a;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        .sale-type-card:hover {
            border-color: #ff6b00;
            background: #404040;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }
        .sale-type-card.active {
            border-color: #ff6b00;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.2) 0%, rgba(255, 107, 0, 0.1) 100%);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.4);
            transform: scale(1.05);
        }
        .sale-type-card.active::before {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b00;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        .sale-type-card h3 {
            color: #fff;
            margin: 10px 0 5px 0;
            font-size: 16px;
            transition: color 0.3s;
        }
        .sale-type-card.active h3 {
            color: #ff6b00;
            font-weight: 600;
        }
        .sale-type-card p {
            color: #999;
            font-size: 12px;
            transition: color 0.3s;
        }
        .sale-type-card.active p {
            color: #ffb366;
        }
        .sale-type-card h3 {
            color: #fff;
            margin: 10px 0 5px 0;
            font-size: 16px;
        }
        .sale-type-card p {
            color: #999;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
            .stat-value { font-size: 28px; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://uijtwnzfhkgzxmdtrxjm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpanR3bnpmaGtnenhtZHRyeGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMTY5NzksImV4cCI6MjA3NTc5Mjk3OX0.pM9RF3LKPzWpBqiXi75Mj9wQiRw4ysbaItfFPEdq6fE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPage = 'register';
        let currentUser = null;
        let selectedSaleType = '';
        let selectedPeriod = 'daily';
        let customStartDate = getTodayDate();
        let customEndDate = getTodayDate();

        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        const icons = {
            user: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            userLg: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            lock: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',
            lockLg: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',
            dashboard: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',
            dollar: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
            chart: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>',
            package: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
            shoppingCart: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>',
            list: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>',
            logout: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
            check: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            wifi: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>',
            smartphone: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
            layers: '<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>',
            inbox: '<svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>'
        };

        async function register(fullName, email, phone, password) {
            try {
                const result = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName,
                            phone: phone
                        },
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (result.error) throw result.error;
                
                if (result.data.user) {
                    await new Promise(function(resolve) {
                        setTimeout(resolve, 500);
                    });
                    
                    const insertResult = await supabase.from('users').insert([{
                        id: result.data.user.id,
                        full_name: fullName,
                        email: email,
                        phone: phone,
                        password: password,
                        status: 'Pendente',
                        is_admin: false,
                        payment_status: 'Pendente'
                    }]);
                    
                    if (insertResult.error) {
                        console.warn('Aviso:', insertResult.error);
                    }
                }
                
                alert('Cadastro realizado! Aguarde a aprova√ß√£o do administrador e realize o pagamento de R$ 5,00 para ter acesso completo.');
                return true;
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao cadastrar: ' + error.message);
                return false;
            }
        }

        async function login(email, password) {
            try {
                console.log('Tentando login com:', email);
                
                const result = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (result.error) throw result.error;
                
                console.log('Login auth OK, buscando dados do usu√°rio...');
                
                // Buscar dados do usu√°rio na tabela
                const userData = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                console.log('Dados do usu√°rio:', userData);
                
                if (userData.error) {
                    console.warn('Erro ao buscar usu√°rio, continuando sem dados extras');
                    currentUser = result.data.user;
                    currentUser.userData = null;
                    return true;
                }
                
                currentUser = result.data.user;
                currentUser.userData = userData.data;
                
                // Verificar se √© admin
                if (userData.data.is_admin) {
                    console.log('Usu√°rio √© admin');
                    return true;
                }
                
                // Verificar status do usu√°rio
                if (userData.data.status === 'Rejeitado') {
                    await supabase.auth.signOut();
                    alert('Seu cadastro foi rejeitado pelo administrador. Entre em contato para mais informa√ß√µes.');
                    return false;
                }
                
                if (userData.data.status === 'Pendente') {
                    await supabase.auth.signOut();
                    alert('Seu cadastro est√° aguardando aprova√ß√£o do administrador.');
                    return false;
                }
                
                // Verificar pagamento
                if (userData.data.payment_status === 'Pendente') {
                    console.log('Redirecionando para pagamento');
                    currentPage = 'payment';
                    return true;
                }
                
                console.log('Login completo com sucesso');
                return true;
            } catch (error) {
                console.error('Erro no login:', error);
                alert('Erro ao fazer login: ' + error.message);
                return false;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
        }

        async function addSale(saleType, customerCPF, quantity, iccid, status) {
            try {
                const finalStatus = saleType === 'BrisaChip' ? 'Efetivado' : (status || 'Pendente');
                
                const result = await supabase.from('sales').insert([{
                    user_id: currentUser.id,
                    service_type: saleType,
                    customer_cpf: customerCPF,
                    quantity: parseInt(quantity),
                    iccid: iccid || null,
                    status: finalStatus,
                    created_at: new Date().toISOString()
                }]);
                
                if (result.error) throw result.error;
                return true;
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro: ' + error.message);
                return false;
            }
        }

        async function deleteSale(saleId) {
            try {
                console.log('Tentando excluir venda:', saleId);
                const result = await supabase
                    .from('sales')
                    .delete()
                    .eq('id', saleId)
                    .eq('user_id', currentUser.id);
                
                if (result.error) {
                    console.error('Erro ao excluir:', result.error);
                    alert('Erro ao excluir: ' + result.error.message);
                    throw result.error;
                }
                
                console.log('Venda exclu√≠da com sucesso');
                return true;
            } catch (error) {
                console.error('Erro:', error);
                return false;
            }
        }

        async function getSales() {
            try {
                const result = await supabase
                    .from('sales')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                return result.error ? [] : result.data;
            } catch (error) {
                return [];
            }
        }

        function filterSalesByPeriod(sales, period) {
            const now = new Date();
            const filtered = sales.filter(function(sale) {
                const saleDate = new Date(sale.created_at);
                
                if (period === 'daily') {
                    return saleDate.toDateString() === now.toDateString();
                } else if (period === 'weekly') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return saleDate >= weekAgo;
                } else if (period === 'monthly') {
                    return saleDate.getMonth() === now.getMonth() && 
                           saleDate.getFullYear() === now.getFullYear();
                } else if (period === 'custom') {
                    if (!customStartDate || !customEndDate) return true;
                    const startDate = new Date(customStartDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(customEndDate);
                    endDate.setHours(23, 59, 59, 999);
                    return saleDate >= startDate && saleDate <= endDate;
                }
                return true;
            });
            
            return filtered;
        }

        function formatDateBR(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }

        async function updateSaleStatus(saleId, newStatus) {
            try {
                const result = await supabase
                    .from('sales')
                    .update({ status: newStatus })
                    .eq('id', saleId)
                    .eq('user_id', currentUser.id);
                
                if (result.error) throw result.error;
                return true;
            } catch (error) {
                console.error('Erro:', error);
                return false;
            }
        }

        function renderRegisterPage() {
            return `
                <div class="container">
                    <div style="max-width: 500px; margin: 100px auto;">
                        <div class="card">
                            <div class="section-header" style="justify-content: center;">
                                ${icons.userLg}
                                <h1>Cadastro de Usu√°rio</h1>
                            </div>
                            <input type="text" id="fullName" placeholder="Nome Completo">
                            <input type="email" id="email" placeholder="Email">
                            <input type="tel" id="phone" placeholder="Telefone">
                            <input type="password" id="password" placeholder="Senha (m√≠nimo 6 caracteres)">
                            <button id="btnRegister" onclick="handleRegister()">
                                ${icons.check}
                                <span>Cadastrar</span>
                            </button>
                            <p class="text-center" style="margin-top: 15px; color: #999;">
                                J√° tem uma conta? 
                                <span class="link" onclick="changePage('login')">Fa√ßa login</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPaymentPage() {
            return `
                <div class="container">
                    <div class="payment-card">
                        <div class="card">
                            <h1 style="text-align: center;">üí≥ Pagamento Necess√°rio</h1>
                            <p style="color: #999; text-align: center; margin: 20px 0;">
                                Para ter acesso completo ao sistema, realize o pagamento da taxa de ativa√ß√£o:
                            </p>
                            <div class="payment-value">R$ 5,00</div>
                            <div class="payment-info">
                                <p style="color: #ccc; margin-bottom: 10px;">
                                    ${icons.check} Acesso vital√≠cio ao sistema
                                </p>
                                <p style="color: #ccc; margin-bottom: 10px;">
                                    ${icons.check} Gerenciamento de vendas ilimitado
                                </p>
                                <p style="color: #ccc;">
                                    ${icons.check} Dashboard completo com relat√≥rios
                                </p>
                            </div>
                            <button onclick="simulatePayment()" style="margin-top: 20px;">
                                ${icons.dollar}
                                <span>Simular Pagamento (R$ 5,00)</span>
                            </button>
                            <button onclick="handleLogout()" class="btn-secondary" style="margin-top: 10px;">
                                ${icons.logout}
                                <span>Sair</span>
                            </button>
                            <p style="color: #777; font-size: 12px; margin-top: 20px;">
                                * Este √© um pagamento simulado para demonstra√ß√£o
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderAdminPage() {
            const allUsersResult = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });
            
            const allUsers = allUsersResult.data || [];
            const pendingUsers = allUsers.filter(function(u) { return u.status === 'Pendente' && !u.is_admin; });
            const approvedUsers = allUsers.filter(function(u) { return u.status === 'Aprovado' && !u.is_admin; });
            const rejectedUsers = allUsers.filter(function(u) { return u.status === 'Rejeitado' && !u.is_admin; });

            return `
                <div class="container">
                    <div class="card">
                        <div class="flex-between">
                            <div class="section-header" style="margin: 0;">
                                ${icons.settings}
                                <h1 style="margin: 0;">Painel do Administrador</h1>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="changePage('dashboard')" style="width: auto; padding: 12px 24px;">
                                    ${icons.dashboard}
                                    <span>Dashboard</span>
                                </button>
                                <button class="btn-secondary" onclick="handleLogout()" style="width: auto; padding: 12px 24px;">
                                    ${icons.logout}
                                    <span>Sair</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.package}
                                <span>Cadastros Pendentes</span>
                            </div>
                            <div class="stat-value">${pendingUsers.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.check}
                                <span>Usu√°rios Aprovados</span>
                            </div>
                            <div class="stat-value">${approvedUsers.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.user}
                                <span>Total de Usu√°rios</span>
                            </div>
                            <div class="stat-value">${allUsers.filter(function(u) { return !u.is_admin; }).length}</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.package}
                            <h2 style="margin: 0;">Cadastros Pendentes de Aprova√ß√£o</h2>
                        </div>
                        ${pendingUsers.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>Data de Cadastro</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingUsers.map(function(user) {
                                            return `
                                            <tr>
                                                <td>${user.full_name}</td>
                                                <td>${user.email}</td>
                                                <td>${user.phone}</td>
                                                <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
                                                <td style="display: flex; gap: 8px;">
                                                    <button onclick="approveUser('${user.id}')" class="btn-approve">Aprovar</button>
                                                    <button onclick="rejectUser('${user.id}')" class="btn-reject">Rejeitar</button>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                ${icons.inbox}
                                <p>Nenhum cadastro pendente</p>
                            </div>
                        `}
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.check}
                            <h2 style="margin: 0;">Usu√°rios Aprovados</h2>
                        </div>
                        ${approvedUsers.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>Status Pagamento</th>
                                            <th>Data de Cadastro</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${approvedUsers.map(function(user) {
                                            return `
                                            <tr>
                                                <td>${user.full_name}</td>
                                                <td>${user.email}</td>
                                                <td>${user.phone}</td>
                                                <td>
                                                    <span class="status-badge status-${user.payment_status.toLowerCase()}">
                                                        ${user.payment_status}
                                                    </span>
                                                </td>
                                                <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                ${icons.inbox}
                                <p>Nenhum usu√°rio aprovado ainda</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        async function approveUser(userId) {
            if (confirm('Deseja aprovar este usu√°rio?')) {
                const result = await supabase
                    .from('users')
                    .update({ status: 'Aprovado' })
                    .eq('id', userId);
                
                if (!result.error) {
                    alert('Usu√°rio aprovado com sucesso!');
                    changePage('admin');
                }
            }
        }

        async function rejectUser(userId) {
            if (confirm('Deseja rejeitar este usu√°rio?')) {
                const result = await supabase
                    .from('users')
                    .update({ status: 'Rejeitado' })
                    .eq('id', userId);
                
                if (!result.error) {
                    alert('Usu√°rio rejeitado!');
                    changePage('admin');
                }
            }
        }

        async function simulatePayment() {
            if (confirm('Confirmar pagamento simulado de R$ 5,00?')) {
                const result = await supabase
                    .from('users')
                    .update({ 
                        payment_status: 'Aprovado',
                        payment_date: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (!result.error) {
                    alert('Pagamento confirmado! Bem-vindo ao sistema!');
                    changePage('dashboard');
                }
            }
        }

        function renderLoginPage() {
            return `
                <div class="container">
                    <div style="max-width: 500px; margin: 100px auto;">
                        <div class="card">
                            <div class="section-header" style="justify-content: center;">
                                ${icons.lockLg}
                                <h1>Login</h1>
                            </div>
                            <input type="email" id="loginEmail" placeholder="Email">
                            <input type="password" id="loginPassword" placeholder="Senha">
                            <button id="btnLogin" onclick="handleLogin()">
                                ${icons.check}
                                <span>Entrar</span>
                            </button>
                            <p class="text-center" style="margin-top: 15px; color: #999;">
                                N√£o tem uma conta? 
                                <span class="link" onclick="changePage('register')">Cadastre-se</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderDashboard() {
            // Verificar se √© admin e mostrar bot√£o
            const isAdmin = currentUser.userData && currentUser.userData.is_admin;
            
            console.log('Renderizando dashboard. √â admin?', isAdmin);
            console.log('User data:', currentUser.userData);
            
            const allSales = await getSales();
            const sales = filterSalesByPeriod(allSales, selectedPeriod);
            
            const totalSales = sales.length;
            const efetivados = sales.filter(function(s) { return s.status === 'Efetivado'; }).length;
            const pendentes = sales.filter(function(s) { return s.status === 'Pendente'; }).length;
            
            const comboSales = sales.filter(function(s) { return s.service_type === 'Combo'; }).length;
            const chipSales = sales.filter(function(s) { return s.service_type === 'BrisaChip'; }).length;
            const fibraSales = sales.filter(function(s) { return s.service_type === 'Fibra'; }).length;
            
            let periodText = '';
            if (selectedPeriod === 'daily') {
                periodText = 'Hoje';
            } else if (selectedPeriod === 'weekly') {
                periodText = 'Esta Semana';
            } else if (selectedPeriod === 'monthly') {
                periodText = 'Este M√™s';
            } else if (selectedPeriod === 'custom') {
                if (customStartDate && customEndDate) {
                    periodText = formatDateBR(customStartDate) + ' at√© ' + formatDateBR(customEndDate);
                } else {
                    periodText = 'Per√≠odo Personalizado';
                }
            }

            return `
                <div class="container">
                    <div class="card">
                        <div class="flex-between">
                            <div class="section-header" style="margin: 0;">
                                ${icons.dashboard}
                                <div>
                                    <h1 style="margin: 0;">Dashboard de Vendas</h1>
                                    <p style="color: #999; margin-top: 5px;">Bem-vindo, ${currentUser.user_metadata && currentUser.user_metadata.full_name ? currentUser.user_metadata.full_name : currentUser.email}</p>
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="handleLogout()" style="width: auto; padding: 12px 24px;">
                                ${icons.logout}
                                <span>Sair</span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 style="text-align: center; margin-bottom: 15px;">Per√≠odo: ${periodText}</h2>
                        <div class="period-selector">
                            <button class="period-btn ${selectedPeriod === 'daily' ? 'active' : ''}" onclick="changePeriod('daily')">Di√°rio</button>
                            <button class="period-btn ${selectedPeriod === 'weekly' ? 'active' : ''}" onclick="changePeriod('weekly')">Semanal</button>
                            <button class="period-btn ${selectedPeriod === 'monthly' ? 'active' : ''}" onclick="changePeriod('monthly')">Mensal</button>
                            <button class="period-btn ${selectedPeriod === 'custom' ? 'active' : ''}" onclick="changePeriod('custom')">Personalizado</button>
                        </div>
                        ${selectedPeriod === 'custom' ? `
                            <div class="date-range-selector">
                                <div class="date-input-wrapper">
                                    <label class="date-label">Data Inicial</label>
                                    <input type="date" id="startDate" class="date-input" value="${customStartDate}" onchange="updateCustomDate()">
                                </div>
                                <div class="date-input-wrapper">
                                    <label class="date-label">Data Final</label>
                                    <input type="date" id="endDate" class="date-input" value="${customEndDate}" onchange="updateCustomDate()">
                                </div>
                                <button onclick="applyCustomPeriod()" class="btn-apply">
                                    ${icons.check}
                                    <span>Aplicar Per√≠odo</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.chart}
                                <span>Total de Vendas</span>
                            </div>
                            <div class="stat-value">${totalSales}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.check}
                                <span>Efetivados</span>
                            </div>
                            <div class="stat-value">${efetivados}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.package}
                                <span>Pendentes</span>
                            </div>
                            <div class="stat-value">${pendentes}</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.layers}
                            <h2 style="margin: 0;">Vendas por Tipo de Servi√ßo (${periodText})</h2>
                        </div>
                        <div class="grid">
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">
                                        ${icons.layers}
                                    </div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">Combo (Internet + Chip)</span>
                                </div>
                                <div class="service-stat-value">${comboSales}</div>
                                <div class="service-stat-label">vendas realizadas</div>
                            </div>
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">
                                        ${icons.smartphone}
                                    </div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">BrisaChip</span>
                                </div>
                                <div class="service-stat-value">${chipSales}</div>
                                <div class="service-stat-label">chips vendidos</div>
                            </div>
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">
                                        ${icons.wifi}
                                    </div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">FTTH (Fibra √ìptica)</span>
                                </div>
                                <div class="service-stat-value">${fibraSales}</div>
                                <div class="service-stat-label">fibras instaladas</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.shoppingCart}
                            <h2 style="margin: 0;">Registrar Nova Venda</h2>
                        </div>
                        
                        <div class="sale-type-selector">
                            <div class="sale-type-card ${selectedSaleType === 'Combo' ? 'active' : ''}" onclick="selectSaleType('Combo')">
                                ${icons.layers}
                                <h3>Internet Fibra + BrisaChip</h3>
                                <p>Combo completo</p>
                            </div>
                            <div class="sale-type-card ${selectedSaleType === 'BrisaChip' ? 'active' : ''}" onclick="selectSaleType('BrisaChip')">
                                ${icons.smartphone}
                                <h3>BrisaChip</h3>
                                <p>Chip avulso</p>
                            </div>
                            <div class="sale-type-card ${selectedSaleType === 'Fibra' ? 'active' : ''}" onclick="selectSaleType('Fibra')">
                                ${icons.wifi}
                                <h3>Fibra √ìptica</h3>
                                <p>Internet avulsa</p>
                            </div>
                        </div>

                        <div id="saleForm"></div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.list}
                            <h2 style="margin: 0;">Hist√≥rico de Vendas (${periodText})</h2>
                        </div>
                        ${sales.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>CPF</th>
                                            <th>Qtd</th>
                                            <th>ICCID</th>
                                            <th>Status</th>
                                            <th>Data</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sales.map(function(sale) {
                                            return `
                                            <tr>
                                                <td>${sale.service_type}</td>
                                                <td>${sale.customer_cpf}</td>
                                                <td>${sale.quantity}</td>
                                                <td>${sale.iccid || '-'}</td>
                                                <td>
                                                    <span class="status-badge status-${sale.status.toLowerCase()}">
                                                        ${sale.status}
                                                    </span>
                                                </td>
                                                <td>${new Date(sale.created_at).toLocaleDateString('pt-BR')}</td>
                                                <td style="display: flex; gap: 8px;">
                                                    ${sale.service_type !== 'BrisaChip' ? (
                                                        sale.status === 'Pendente' 
                                                        ? `<button onclick="toggleStatus('${sale.id}', 'Efetivado')" style="width: auto; padding: 8px 16px; font-size: 12px; background: #28a745;">Efetivar</button>`
                                                        : `<button onclick="toggleStatus('${sale.id}', 'Pendente')" style="width: auto; padding: 8px 16px; font-size: 12px; background: #ffc107; color: #1a1a1a;">Pendente</button>`
                                                    ) : ''}
                                                    <button onclick="handleDeleteSale('${sale.id}')" class="btn-delete">Excluir</button>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="empty-state">
                                ${icons.inbox}
                                <p>Nenhuma venda registrada neste per√≠odo</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function selectSaleType(type) {
            selectedSaleType = type;
            
            // Atualizar visualmente os cards
            const cards = document.querySelectorAll('.sale-type-card');
            cards.forEach(function(card) {
                card.classList.remove('active');
            });
            
            // Adicionar classe active ao card clicado
            event.target.closest('.sale-type-card').classList.add('active');
            
            renderSaleForm();
        }

        function renderSaleForm() {
            const formContainer = document.getElementById('saleForm');
            if (!formContainer) return;

            let formHTML = '';

            if (selectedSaleType === 'Combo') {
                formHTML = '<div class="form-group">' +
                    '<label class="form-label">CPF do Cliente</label>' +
                    '<input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label class="form-label">Quantidade</label>' +
                    '<input type="number" id="quantity" value="1" min="1">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label class="form-label">Status</label>' +
                    '<select id="status">' +
                    '<option value="Pendente">Pendente</option>' +
                    '<option value="Efetivado">Efetivado</option>' +
                    '</select>' +
                    '</div>' +
                    '<button onclick="handleAddSale()">' +
                    icons.check +
                    '<span>Registrar Venda</span>' +
                    '</button>';
            } else if (selectedSaleType === 'BrisaChip') {
                formHTML = '<div class="form-group">' +
                    '<label class="form-label">CPF do Cliente</label>' +
                    '<input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label class="form-label">Quantidade</label>' +
                    '<input type="number" id="quantity" value="1" min="1">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label class="form-label">ICCID (Obrigat√≥rio)</label>' +
                    '<input type="text" id="iccid" placeholder="Digite o ICCID do chip">' +
                    '</div>' +
                    '<button onclick="handleAddSale()">' +
                    icons.check +
                    '<span>Registrar Venda</span>' +
                    '</button>';
            } else if (selectedSaleType === 'Fibra') {
                formHTML = '<div class="form-group">' +
                    '<label class="form-label">CPF do Cliente</label>' +
                    '<input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label class="form-label">Quantidade</label>' +
                    '<input type="number" id="quantity" value="1" min="1">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label class="form-label">Status</label>' +
                    '<select id="status">' +
                    '<option value="Pendente">Pendente</option>' +
                    '<option value="Efetivado">Efetivado</option>' +
                    '</select>' +
                    '</div>' +
                    '<button onclick="handleAddSale()">' +
                    icons.check +
                    '<span>Registrar Venda</span>' +
                    '</button>';
            } else {
                formHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">Selecione um tipo de servi√ßo acima</p>';
            }

            formContainer.innerHTML = formHTML;
        }

        async function handleRegister() {
            const btn = document.getElementById('btnRegister');
            btn.disabled = true;
            btn.innerHTML = icons.check + '<span>Cadastrando...</span>';
            
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;

            if (!fullName || !email || !phone || !password) {
                alert('Preencha todos os campos!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            if (password.length < 6) {
                alert('A senha deve ter no m√≠nimo 6 caracteres!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Cadastrar</span>';
                return;
            }

            const success = await register(fullName, email, phone, password);
            if (success) {
                changePage('login');
            }
            
            btn.disabled = false;
            btn.innerHTML = icons.check + '<span>Cadastrar</span>';
        }

        async function handleLogin() {
            const btn = document.getElementById('btnLogin');
            btn.disabled = true;
            btn.innerHTML = icons.check + '<span>Entrando...</span>';
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Preencha todos os campos!');
                btn.disabled = false;
                btn.innerHTML = icons.check + '<span>Entrar</span>';
                return;
            }

            const success = await login(email, password);
            if (success) {
                if (currentPage === 'payment') {
                    await render();
                } else {
                    await changePage('dashboard');
                }
            }
            
            btn.disabled = false;
            btn.innerHTML = icons.check + '<span>Entrar</span>';
        }

        async function handleLogout() {
            if (confirm('Deseja realmente sair?')) {
                await logout();
                changePage('login');
            }
        }

        async function handleAddSale() {
            const cpfInput = document.getElementById('customerCPF');
            const quantityInput = document.getElementById('quantity');
            const iccidInput = document.getElementById('iccid');
            const statusInput = document.getElementById('status');
            
            const customerCPF = cpfInput ? cpfInput.value.trim() : '';
            const quantity = quantityInput ? quantityInput.value : '1';
            const iccid = iccidInput ? iccidInput.value.trim() : '';
            const status = statusInput ? statusInput.value : 'Pendente';

            if (!selectedSaleType) {
                alert('Selecione o tipo de servi√ßo!');
                return;
            }

            if (!customerCPF || !quantity) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            if (selectedSaleType === 'BrisaChip' && !iccid) {
                alert('O campo ICCID √© obrigat√≥rio para BrisaChip!');
                return;
            }

            const success = await addSale(selectedSaleType, customerCPF, quantity, iccid, status);
            if (success) {
                alert('Venda registrada com sucesso!');
                selectedSaleType = '';
                await changePage('dashboard');
            }
        }

        async function toggleStatus(saleId, newStatus) {
            const success = await updateSaleStatus(saleId, newStatus);
            if (success) {
                await changePage('dashboard');
            }
        }

        async function handleDeleteSale(saleId) {
            if (confirm('Tem certeza que deseja excluir esta venda?')) {
                const success = await deleteSale(saleId);
                if (success) {
                    await changePage('dashboard');
                }
            }
        }

        function changePeriod(period) {
            selectedPeriod = period;
            if (period !== 'custom') {
                customStartDate = '';
                customEndDate = '';
            }
            changePage('dashboard');
        }

        function updateCustomDate() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            if (startInput) customStartDate = startInput.value;
            if (endInput) customEndDate = endInput.value;
        }

        function applyCustomPeriod() {
            updateCustomDate();
            if (!customStartDate || !customEndDate) {
                alert('Selecione as datas de in√≠cio e fim!');
                return;
            }
            if (new Date(customStartDate) > new Date(customEndDate)) {
                alert('A data inicial n√£o pode ser maior que a data final!');
                return;
            }
            changePage('dashboard');
        }

        async function changePage(page) {
            currentPage = page;
            await render();
        }

        async function render() {
            let html = '';
            
            if (currentPage === 'register') {
                html = renderRegisterPage();
            } else if (currentPage === 'login') {
                html = renderLoginPage();
            } else if (currentPage === 'payment') {
                html = renderPaymentPage();
            } else if (currentPage === 'admin') {
                html = await renderAdminPage();
            } else if (currentPage === 'dashboard') {
                html = await renderDashboard();
            }
            
            document.getElementById('app').innerHTML = html;
        }

        async function init() {
            const sessionResult = await supabase.auth.getSession();
            
            if (sessionResult.data.session) {
                currentUser = sessionResult.data.session.user;
                currentPage = 'dashboard';
            }
            
            await render();
        }

        init();
    </script>
</body>
</html>
