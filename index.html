<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Vendas Brisanet</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/7086/7086783.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /*  Added animated background effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 140, 0, 0.08) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 107, 0, 0.03) 2px, rgba(255, 107, 0, 0.03) 4px);
            animation: moveBackground 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes moveBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        .card { 
            background: rgba(42, 42, 42, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 12px; 
            padding: 30px; 
            margin-bottom: 20px;
            border: 2px solid #ff6b00;
            box-shadow: 0 8px 32px rgba(255, 107, 0, 0.2);
        }

// ... existing code ...

        /*  Added calendar styles for sales history */
        .calendar-container {
            background: rgba(42, 42, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .calendar-header h3 {
            color: #ff6b00;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }
        
        .calendar-nav-btn {
            background: #3a3a3a;
            border: 2px solid #555;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .calendar-nav-btn:hover {
            border-color: #ff6b00;
            background: #404040;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            color: #ff6b00;
            font-weight: 600;
            font-size: 12px;
            padding: 10px 5px;
            text-transform: uppercase;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 60px;
        }
        
        .calendar-day:hover {
            border-color: #ff6b00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        .calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
        }
        
        .calendar-day.has-sales {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.3) 0%, rgba(40, 167, 69, 0.1) 100%);
            border-color: #28a745;
        }
        
        .calendar-day.has-sales:hover {
            border-color: #28a745;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.3) 0%, rgba(255, 107, 0, 0.1) 100%);
            border-color: #ff6b00;
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.5);
        }
        
        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .calendar-day-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #28a745;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .sales-details {
            background: rgba(58, 58, 58, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #ff6b00;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .sales-details h4 {
            color: #ff6b00;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .sale-item {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .sale-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .sale-item-type {
            font-weight: 600;
            color: #ff6b00;
            font-size: 14px;
        }
        
        .sale-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #ccc;
        }
        
        .sale-item-detail {
            display: flex;
            flex-direction: column;
        }
        
        .sale-item-detail-label {
            color: #999;
            font-size: 11px;
            margin-bottom: 3px;
        }
        
        .sale-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 20px; margin-bottom: 15px; }
            
            /*  Improved mobile calendar layout */
            .calendar-container {
                padding: 15px;
            }
            
            .calendar-header h3 {
                font-size: 16px;
            }
            
            .calendar-nav-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .calendar-grid {
                gap: 4px;
            }
            
            .calendar-day-header {
                font-size: 10px;
                padding: 8px 2px;
            }
            
            .calendar-day {
                min-height: 50px;
                border-radius: 6px;
            }
            
            .calendar-day-number {
                font-size: 14px;
            }
            
            .calendar-day-badge {
                font-size: 9px;
                padding: 2px 4px;
                top: 2px;
                right: 2px;
            }
            
            .sales-details {
                padding: 15px;
            }
            
            .sales-details h4 {
                font-size: 14px;
            }
            
            .sale-item {
                padding: 12px;
            }
            
            .sale-item-type {
                font-size: 13px;
            }
            
            .sale-item-details {
                grid-template-columns: 1fr;
                gap: 8px;
                font-size: 12px;
            }
            
            .sale-item-actions {
                flex-direction: column;
            }
            
            .sale-item-actions button {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .calendar-day {
                min-height: 45px;
            }
            
            .calendar-day-number {
                font-size: 12px;
            }
            
            .calendar-grid {
                gap: 3px;
            }
        }

// ... existing code ...

    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://uijtwnzfhkgzxmdtrxjm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpanR3bnpmaGtnenhtZHRyeGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMTY5NzksImV4cCI6MjA3NTc5Mjk3OX0.pM9RF3LKPzWpBqiXi75Mj9wQiRw4ysbaItfFPEdq6fE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentPage = 'login';
        let currentUser = null;
        let selectedSaleType = '';
        let selectedPeriod = 'monthly';
        let customStartDate = '';
        let customEndDate = '';
        let selectedPlan = '';
        
        //  Added calendar state variables
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        let selectedDate = null;

// ... existing code ...

        //  Added calendar functions
        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }
        
        function getFirstDayOfMonth(month, year) {
            return new Date(year, month, 1).getDay();
        }
        
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getSalesByDate(sales) {
            const salesByDate = {};
            sales.forEach(sale => {
                const date = new Date(sale.created_at);
                const dateKey = formatDateKey(date);
                if (!salesByDate[dateKey]) {
                    salesByDate[dateKey] = [];
                }
                salesByDate[dateKey].push(sale);
            });
            return salesByDate;
        }
        
        function changeCalendarMonth(direction) {
            if (direction === 'prev') {
                calendarMonth--;
                if (calendarMonth < 0) {
                    calendarMonth = 11;
                    calendarYear--;
                }
            } else {
                calendarMonth++;
                if (calendarMonth > 11) {
                    calendarMonth = 0;
                    calendarYear++;
                }
            }
            selectedDate = null;
            changePage('dashboard');
        }
        
        function selectCalendarDate(day) {
            if (!day) return;
            selectedDate = new Date(calendarYear, calendarMonth, day);
            changePage('dashboard');
        }
        
        function renderCalendar(sales) {
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            
            const daysInMonth = getDaysInMonth(calendarMonth, calendarYear);
            const firstDay = getFirstDayOfMonth(calendarMonth, calendarYear);
            const salesByDate = getSalesByDate(sales);
            
            let calendarHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth('prev')">‚Äπ</button>
                        <h3>${monthNames[calendarMonth]} ${calendarYear}</h3>
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth('next')">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid">
            `;
            
            // Day headers
            dayNames.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div class="calendar-day empty"></div>`;
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(calendarYear, calendarMonth, day);
                const dateKey = formatDateKey(date);
                const daySales = salesByDate[dateKey] || [];
                const hasSales = daySales.length > 0;
                const isSelected = selectedDate && formatDateKey(selectedDate) === dateKey;
                
                calendarHTML += `
                    <div class="calendar-day ${hasSales ? 'has-sales' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectCalendarDate(${day})">
                        <span class="calendar-day-number">${day}</span>
                        ${hasSales ? `<span class="calendar-day-badge">${daySales.length}</span>` : ''}
                    </div>
                `;
            }
            
            calendarHTML += `
                    </div>
                </div>
            `;
            
            // Show sales details if a date is selected
            if (selectedDate) {
                const dateKey = formatDateKey(selectedDate);
                const daySales = salesByDate[dateKey] || [];
                
                if (daySales.length > 0) {
                    calendarHTML += `
                        <div class="sales-details">
                            <h4>üìÖ Vendas de ${formatDateBR(selectedDate)} (${daySales.length} ${daySales.length === 1 ? 'venda' : 'vendas'})</h4>
                            ${daySales.map(sale => `
                                <div class="sale-item">
                                    <div class="sale-item-header">
                                        <span class="sale-item-type">${sale.service_type}</span>
                                        <span class="status-badge status-${sale.status.toLowerCase()}">${sale.status}</span>
                                    </div>
                                    <div class="sale-item-details">
                                        <div class="sale-item-detail">
                                            <span class="sale-item-detail-label">CPF</span>
                                            <span>${sale.customer_cpf || 'N√£o informado'}</span>
                                        </div>
                                        <div class="sale-item-detail">
                                            <span class="sale-item-detail-label">Quantidade</span>
                                            <span>${sale.quantity}</span>
                                        </div>
                                        ${sale.iccid ? `
                                            <div class="sale-item-detail">
                                                <span class="sale-item-detail-label">ICCID</span>
                                                <span>${sale.iccid}</span>
                                            </div>
                                        ` : ''}
                                        ${sale.plan ? `
                                            <div class="sale-item-detail">
                                                <span class="sale-item-detail-label">Plano</span>
                                                <span>${sale.plan}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="sale-item-actions">
                                        ${sale.service_type !== 'BrisaChip' ? (
                                            sale.status === 'Pendente' 
                                            ? `<button onclick="toggleStatus('${sale.id}', 'Efetivado')" style="width: auto; padding: 8px 16px; font-size: 12px; background: #28a745;">‚úì Efetivar</button>`
                                            : `<button onclick="toggleStatus('${sale.id}', 'Pendente')" style="width: auto; padding: 8px 16px; font-size: 12px; background: #ffc107; color: #1a1a1a;">‚Ü∂ Pendente</button>`
                                        ) : '<span style="color: #28a745; font-size: 12px;">‚úì Auto-efetivado</span>'}
                                        <button onclick="handleDeleteSale('${sale.id}')" class="btn-delete">üóë Excluir</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            return calendarHTML;
        }

        async function renderDashboard() {
            const allSales = await getSales();
            const sales = filterSalesByPeriod(allSales, selectedPeriod);
            
            // Contar apenas vendas EFETIVADAS para as estat√≠sticas
            const efetivadosSales = sales.filter(s => s.status === 'Efetivado');
            const totalSales = efetivadosSales.length;
            const efetivados = efetivadosSales.length;
            const pendentes = sales.filter(s => s.status === 'Pendente').length;
            
            // Contar tipos de servi√ßo apenas EFETIVADOS
            const comboSales = efetivadosSales.filter(s => s.service_type === 'Combo').length;
            const chipSales = efetivadosSales.filter(s => s.service_type === 'BrisaChip').length;
            const fibraSales = efetivadosSales.filter(s => s.service_type === 'Fibra').length;
            
            const now = new Date();
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const currentMonth = monthNames[now.getMonth()];
            const currentYear = now.getFullYear();
            
            let periodText = '';
            if (selectedPeriod === 'daily') periodText = 'Hoje';
            else if (selectedPeriod === 'weekly') periodText = 'Esta Semana';
            else if (selectedPeriod === 'monthly') periodText = `${currentMonth} de ${currentYear}`;
            else if (selectedPeriod === 'custom') {
                periodText = (customStartDate && customEndDate) 
                    ? formatDateBR(customStartDate) + ' at√© ' + formatDateBR(customEndDate)
                    : 'Per√≠odo Personalizado';
            }

            return `
                <div class="container">
                    <div class="system-title" style="margin-top: 20px;">
                        <h1>
                            <span class="title-icon">${icons.barChart}</span>
                            <span>Registro de Vendas Brisanet</span>
                        </h1>
                        <div class="subtitle">Sistema de Gest√£o Comercial</div>
                    </div>
                    
                    <div class="card">
                        <div class="flex-between">
                            <div class="section-header" style="margin: 0;">
                                ${icons.dashboard}
                                <div>
                                    <h1 style="margin: 0;">Dashboard de Vendas</h1>
                                    <p style="color: #999; margin-top: 5px;">Bem-vindo, ${currentUser.user_metadata?.full_name || currentUser.email}</p>
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="handleLogout()" style="width: auto; padding: 12px 24px;">
                                ${icons.logout}
                                <span>Sair</span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 style="text-align: center; margin-bottom: 15px;">Per√≠odo: ${periodText}</h2>
                        <div class="period-selector">
                            <button class="period-btn ${selectedPeriod === 'daily' ? 'active' : ''}" onclick="changePeriod('daily')">Di√°rio</button>
                            <button class="period-btn ${selectedPeriod === 'weekly' ? 'active' : ''}" onclick="changePeriod('weekly')">Semanal</button>
                            <button class="period-btn ${selectedPeriod === 'monthly' ? 'active' : ''}" onclick="changePeriod('monthly')">Mensal</button>
                            <button class="period-btn ${selectedPeriod === 'custom' ? 'active' : ''}" onclick="changePeriod('custom')">Personalizado</button>
                        </div>
                        ${selectedPeriod === 'custom' ? `
                            <div class="date-range-selector">
                                <div class="date-input-group">
                                    <div class="date-input-label">${icons.calendar} Data Inicial</div>
                                    <button class="date-button" id="startDateBtn">
                                        <div class="date-icon">${icons.calendar}</div>
                                        <span id="startDateText">${customStartDate ? formatDateBR(customStartDate) : 'Selecionar Data'}</span>
                                        <input type="date" id="startDate" value="${customStartDate}" onchange="updateCustomDate('start')">
                                    </button>
                                </div>
                                
                                <div class="date-input-group">
                                    <div class="date-input-label">${icons.calendar} Data Final</div>
                                    <button class="date-button" id="endDateBtn">
                                        <div class="date-icon">${icons.calendar}</div>
                                        <span id="endDateText">${customEndDate ? formatDateBR(customEndDate) : 'Selecionar Data'}</span>
                                        <input type="date" id="endDate" value="${customEndDate}" onchange="updateCustomDate('end')">
                                    </button>
                                </div>
                                
                                <button onclick="applyCustomPeriod()" class="btn-apply" style="margin-top: 24px;">
                                    ${icons.check}
                                    <span>Aplicar Per√≠odo</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.chart}
                                <span>Total de Vendas</span>
                            </div>
                            <div class="stat-value">${totalSales}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.check}
                                <span>Efetivados</span>
                            </div>
                            <div class="stat-value">${efetivados}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                ${icons.package}
                                <span>Pendentes</span>
                            </div>
                            <div class="stat-value">${pendentes}</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.layers}
                            <h2 style="margin: 0;">Vendas por Tipo de Servi√ßo (${periodText})</h2>
                        </div>
                        <div class="grid">
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">${icons.layers}</div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">Combo (Internet + Chip)</span>
                                </div>
                                <div class="service-stat-value">${comboSales}</div>
                                <div class="service-stat-label">vendas realizadas</div>
                            </div>
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">${icons.smartphone}</div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">BrisaChip</span>
                                </div>
                                <div class="service-stat-value">${chipSales}</div>
                                <div class="service-stat-label">chips vendidos</div>
                            </div>
                            <div class="service-stat-card">
                                <div class="service-stat-header">
                                    <div class="service-icon-wrapper">${icons.wifi}</div>
                                    <span style="color: #ccc; font-size: 15px; font-weight: 500;">FTTH (Fibra √ìptica)</span>
                                </div>
                                <div class="service-stat-value">${fibraSales}</div>
                                <div class="service-stat-label">fibras instaladas</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.shoppingCart}
                            <h2 style="margin: 0;">Registrar Nova Venda</h2>
                        </div>
                        
                        <div class="sale-type-selector">
                            <div class="sale-type-card ${selectedSaleType === 'Combo' ? 'active' : ''}" onclick="selectSaleType('Combo')">
                                ${icons.layers}
                                <h3>Internet Fibra + BrisaChip</h3>
                                <p>Combo completo</p>
                            </div>
                            <div class="sale-type-card ${selectedSaleType === 'BrisaChip' ? 'active' : ''}" onclick="selectSaleType('BrisaChip')">
                                ${icons.smartphone}
                                <h3>BrisaChip</h3>
                                <p>Chip avulso</p>
                            </div>
                            <div class="sale-type-card ${selectedSaleType === 'Fibra' ? 'active' : ''}" onclick="selectSaleType('Fibra')">
                                ${icons.wifi}
                                <h3>Fibra √ìptica</h3>
                                <p>Internet avulsa</p>
                            </div>
                        </div>

                        <div id="saleForm"></div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            ${icons.calendar}
                            <h2 style="margin: 0;">Calend√°rio de Vendas</h2>
                        </div>
                        ${renderCalendar(allSales)}
                    </div>
                    
                    <div class="footer-credits">
                        Desenvolvido por <strong>Igor Borges</strong>
                    </div>
                </div>
            `;
        }

        function selectSaleType(type) {
            selectedSaleType = type;
            selectedPlan = '';
            
            const cards = document.querySelectorAll('.sale-type-card');
            cards.forEach(card => card.classList.remove('active'));
            
            event.target.closest('.sale-type-card').classList.add('active');
            
            renderSaleForm();
        }

        function selectPlan(plan) {
            selectedPlan = plan;
            
            const planCards = document.querySelectorAll('.plan-card');
            planCards.forEach(card => card.classList.remove('active'));
            
            if (event && event.target) {
                const clickedCard = event.target.closest('.plan-card');
                if (clickedCard) {
                    clickedCard.classList.add('active');
                }
            }
        }

        function renderSaleForm() {
            const formContainer = document.getElementById('saleForm');
            if (!formContainer) return;

            let formHTML = '';

            if (selectedSaleType === 'Combo') {
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Informa√ß√£o do Plano (Opcional)</label>
                        <input type="text" id="planInfo" placeholder="Ex: 500MB + Brisachip">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPF do Cliente (Opcional)</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="status">
                            <option value="Pendente">Pendente</option>
                            <option value="Efetivado">Efetivado</option>
                        </select>
                    </div>
                    <button onclick="handleAddSale()">
                        ${icons.check}
                        <span>Registrar Venda</span>
                    </button>
                `;
            } else if (selectedSaleType === 'BrisaChip') {
                formHTML = `
                    <div class="form-label" style="margin-bottom: 10px;">Selecione o Plano:</div>
                    <div class="plan-selector">
                        <div class="plan-card ${selectedPlan === '20GB - R$ 29,99' ? 'active' : ''}" onclick="selectPlan('20GB - R$ 29,99')">
                            <div class="plan-gb">20GB</div>
                            <div class="plan-price">R$ 29,99</div>
                        </div>
                        <div class="plan-card ${selectedPlan === '30GB - R$ 39,99' ? 'active' : ''}" onclick="selectPlan('30GB - R$ 39,99')">
                            <div class="plan-gb">30GB</div>
                            <div class="plan-price">R$ 39,99</div>
                        </div>
                        <div class="plan-card ${selectedPlan === '100GB - R$ 49,99' ? 'active' : ''}" onclick="selectPlan('100GB - R$ 49,99')">
                            <div class="plan-gb">100GB</div>
                            <div class="plan-price">R$ 49,99</div>
                        </div>
                    </div>
                    ${selectedPlan ? `
                        <div style="background: rgba(255, 107, 0, 0.1); border: 2px solid #ff6b00; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center;">
                            <span style="color: #ff6b00; font-weight: 600; font-size: 14px;">‚úì Plano Selecionado: ${selectedPlan}</span>
                        </div>
                    ` : ''}
                    <div class="form-group">
                        <label class="form-label">CPF do Cliente (Opcional)</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ICCID (√öltimos 8 d√≠gitos - Obrigat√≥rio)</label>
                        <input type="text" id="iccid" placeholder="Digite os 8 √∫ltimos d√≠gitos" maxlength="8">
                    </div>
                    <button onclick="handleAddSale()">
                        ${icons.check}
                        <span>Registrar Venda</span>
                    </button>
                `;
            } else if (selectedSaleType === 'Fibra') {
                formHTML = `
                    <div class="form-group">
                        <label class="form-label">Informa√ß√£o do Plano (Opcional)</label>
                        <input type="text" id="planInfo" placeholder="Ex: 350MB + Streaming">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPF do Cliente (Opcional)</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="status">
                            <option value="Pendente">Pendente</option>
                            <option value="Efetivado">Efetivado</option>
                        </select>
                    </div>
                    <button onclick="handleAddSale()">
                        ${icons.check}
                        <span>Registrar Venda</span>
                    </button>
                `;
            } else {
                formHTML = '<p style="text-align: center; color: #999; padding: 40px 0;">Selecione um tipo de servi√ßo acima</p>';
            }

            formContainer.innerHTML = formHTML;
        }

// ... existing code ...

        async function handleAddSale() {
            const cpfInput = document.getElementById('customerCPF');
            const quantityInput = document.getElementById('quantity');
            const iccidInput = document.getElementById('iccid');
            const statusInput = document.getElementById('status');
            const planInfoInput = document.getElementById('planInfo');
            
            const customerCPF = cpfInput ? cpfInput.value.trim() || 'N√£o informado' : 'N√£o informado';
            const quantity = quantityInput ? quantityInput.value : '1';
            const iccid = iccidInput ? iccidInput.value.trim() : '';
            const status = statusInput ? statusInput.value : 'Pendente';
            const planInfo = planInfoInput ? planInfoInput.value.trim() : '';

            if (!selectedSaleType) {
                alert('Selecione o tipo de servi√ßo!');
                return;
            }

            if (!quantity) {
                alert('Preencha o campo quantidade!');
                return;
            }

            if (selectedSaleType === 'BrisaChip') {
                if (!iccid) {
                    alert('O campo ICCID √© obrigat√≥rio para BrisaChip!');
                    return;
                }
                if (iccid.length !== 8) {
                    alert('O ICCID deve ter exatamente 8 d√≠gitos!');
                    return;
                }
                if (!/^\d{8}$/.test(iccid)) {
                    alert('O ICCID deve conter apenas n√∫meros!');
                    return;
                }
                if (!selectedPlan) {
                    alert('Selecione um plano para BrisaChip!');
                    return;
                }
            }

            const finalPlan = selectedSaleType === 'BrisaChip' ? selectedPlan : planInfo;
            const success = await addSale(selectedSaleType, customerCPF, quantity, iccid, status, finalPlan);
            if (success) {
                alert('Venda registrada com sucesso!');
                selectedSaleType = '';
                selectedPlan = '';
                await changePage('dashboard');
            }
        }

// ... existing code ...

        async function init() {
            const sessionResult = await supabase.auth.getSession();
            
            if (sessionResult.data.session) {
                currentUser = sessionResult.data.session.user;
                currentPage = 'dashboard';
            }
            
            await render();
        }

        init();
    </script>
</body>
</html>
